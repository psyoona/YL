# Edge가 <sub>-nginx:8080 으로 붙기 때문에 여기서는 8080만 리슨
upstream app_upstream {
  server app:8080;
  keepalive 32;
}

server {
  listen 8080;
  server_name _;

  # 앱 준비 전 잠깐의 502를 줄이기 위한 타임아웃/재시도
  proxy_connect_timeout 5s;
  proxy_read_timeout    60s;

  location / {
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_pass http://app_upstream;
  }

  # 헬스체크(있으면 좋음) — 앱이 /healthz 지원 시 그대로 통과
  location = /healthz {
    proxy_pass http://app_upstream/healthz;
    proxy_set_header Host $host;
  }
}
