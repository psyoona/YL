version: "3.9"

services:
  app:
    build: .
    container_name: app
    environment:
      - ASPNETCORE_URLS=http://+:8080
    expose:
      - "8080"
    volumes:
      - "D:\\AppDatas\\YL\\logs\\app:/app/logs"
    networks:
      - edge_proxy

  docker-nginx:
    image: nginx:1.27
    container_name: docker-nginx
    depends_on:
      - app
    expose:
      - "8080"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - "D:\\AppDatas\\YL\\logs\\nginx:/var/log/nginx"
    command: >
      sh -c 'LOG="/var/log/nginx/access.log";
             if [ ! -s "$$LOG" ]; then
               {
                 echo "#Software: nginx";
                 echo "#Version: 1.0";
                 date -u +"#Date: %Y-%m-%d %H:%M:%S";
                 echo "#Fields: date time s-ip cs-method cs-host cs-uri-stem cs-uri-query c-ip cs(User-Agent) sc-status sc-bytes cs-bytes time-taken upstream-time";
               } > "$$LOG";
             fi;
             exec nginx -g "daemon off;"'
    restart: unless-stopped
    networks:
      - edge_proxy

networks:
  edge_proxy:
    external: true
